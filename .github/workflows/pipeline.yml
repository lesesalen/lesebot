name: pipeline

on: [push, pull_request]

jobs:
  pipeline:
    name: pipeline
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: "3.9"
      - uses: snok/install-poetry@v1

      - uses: actions/cache@v2
        with:
          path: ~/.cache/pypoetry/virtualenvs
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Lints
        run: |
          poetry run black . --check --diff
          poetry run flake8 **/*.py
          poetry run isort --profile black .

  deploy:
    if: startsWith(github.ref, 'refs/tags/v')
    name: Build
    runs-on: ubuntu-latest
    needs: pipeline
    steps:
      - name: Deploy application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            cd lesebot
            git pull
            ./deploy.sh
